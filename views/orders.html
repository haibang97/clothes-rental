<!DOCTYPE HTML>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>Stylease - an outfit rental platform</title>
	<meta name="Description" CONTENT="Stylease is a clothes rental platform based in Singapore.">
	<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">

	<!-- jQuery -->
	<script src="js/jquery-2.0.0.min.js" type="text/javascript"></script>

	<!-- Bootstrap -->
	<script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
	<link href="css/bootstrap.css?v=1.0" rel="stylesheet" type="text/css" />

	<!-- Styles -->
	<link href="css/styles.css" rel="stylesheet" type="text/css" />

	<!-- Font Awesome -->
	<link href="fonts/fontawesome/css/fontawesome-all.min.css" type="text/css" rel="stylesheet">

</head>

<body>
    

	<!-- HEADER START -->
	<header class="section-header">
		<section class="header-main">
			<div class="container">
				<div class="row align-items-center">

					<!-- LOGO START -->
					<div class="col-lg-3">
						<div class="brand-wrap">
							<a href="home"><img class="logo" src="images/logo.png"></a>
						</div>
					</div>
					<!-- LOGO END -->

					<!-- SEARCH BAR START -->
					<div class="col-lg-6 col-sm-6">
						<form action="#" class="search-wrap">
							<div class="input-group">
								<input type="text" class="form-control" placeholder="I am looking for...">
								<div class="input-group-append">
									<button class="btn btn-primary" type="submit">
										<i class="fa fa-search"></i>
									</button>
								</div>
							</div>
						</form>
					</div>
					<!-- SEARCH BAR END -->

					<!-- CART / ACCOUNT START -->
					<div class="col-lg-3 col-sm-6">
						<div class="widgets-wrap d-flex justify-content-end">

							<!-- CART START -->
							<div class="widget-header">
								<a href="#" class="icontext">
									<div class="icon-wrap icon-xs bg2 text-secondary"><i
											class="fa fa-shopping-cart"></i></div>
									<div class="text-wrap cart-size">

									</div>
								</a>
							</div>
							<!-- CART END -->

							<!-- ACCOUNT START -->
							<div class="widget-header dropdown">
								<a href="#" class="ml-3 icontext" data-toggle="dropdown" data-offset="20,10">
									<div class="icon-wrap icon-xs bg2 text-secondary"><i class="fa fa-user"></i></div>
									<div class="text-wrap">
										<small>Hello,</small>
										<span>Lou <i class="fa fa-caret-down"></i></span>
									</div>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									<a class="dropdown-item" href="home-user">Manage my account</a>
									<a class="dropdown-item" href="home-user">My orders</a>
									<a class="dropdown-item" href="home-user">My reviews</a>
									<a class="dropdown-item" href="home">Logout</a>
								</div>
							</div>
							<!-- ACCOUNT END -->
						</div>
					</div>
					<!-- CART / ACCOUNT END -->
				</div>
			</div>
		</section>

		<!-- NAV BAR START -->
		<nav class="navbar navbar-expand navbar-dark bg-green">
			<div class="container">

				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main_nav">
					<span class="navbar-toggler-icon"></span>
				</button>

				<div class="collapse navbar-collapse" id="main_nav">
					<ul class="navbar-nav">
						<li class="nav-item">
							<a class="nav-link" href="home">HOME</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="home">ABOUT US</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="home">SUPPORT</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="home">CONTACT US</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		<!-- NAV BAR END -->

	</header>
	<!-- HEADER END -->

	<!-- USER'S ORDERS START -->
	<section class="section-content py-5">
		<div class="container">
			<div class="card">


				<div class="cart"></div>


			</div>
		</div>
	</section>
	<!-- USER'S ORDERS END -->

	<!-- Load Facebook SDK for JavaScript -->
	<div id="fb-root"></div>
	<script>
		window.fbAsyncInit = function () {
			FB.init({
				xfbml: true,
				version: 'v3.2'
			});
		};

		(function (d, s, id) {
			var js, fjs = d.getElementsByTagName(s)[0];
			if (d.getElementById(id)) return;
			js = d.createElement(s); js.id = id;
			js.src = 'https://connect.facebook.net/en_US/sdk/xfbml.customerchat.js';
			fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));
	</script>

	<!-- Your customer chat code -->
	<div class="fb-customerchat" attribution=setup_tool page_id="299401447397224" theme_color="#81894e"
		greeting_dialog_display="hide">
	</div>

	<!-- FOOTER START -->
	<footer class="section-footer bg-green">
		<div class="container">
			<section class="footer-bottom row text-white">
				<div class="col-sm-6">
					<p>Stylease is a clothes rental platform developed by G3-T4 <br>
						(Bang, Huirong, Nicholas, Timothy, Xavier and Zuo Lin) for the IS213 project.
					</p>
				</div>
			</section>
		</div>
	</footer>
	<!-- FOOTER END -->

</body>

<script>
	$(document).ready(function () {
		var result = ""
		var itemsArray = localStorage.getItem('items') ? JSON.parse(localStorage.getItem('items')) : []
		// Display cart size
		var cart_size = `<small>My Bag</small>
						<span>${itemsArray.length} items</span>`
		$(".cart-size").html(cart_size);

		if (itemsArray.length == 0) {
			result += "<h2> Hi Lou, there is currently no items in your cart. </h2>"
		} else {
			result += `<table class="table table-hover shopping-cart-wrap">
				<thead class="text-muted">
					<tr>
						<th scope="col">My Bag:</th>
						<th scope="col" width="200">Perfect for:</th>
						<th scope="col" width="180" >Action:</th>
					</tr>
				</thead>

				<tbody>`
			itemsArray.forEach(function (item) {
				result += `<tr>
						<td>
							<figure class="media">
								<img src="${item.image_link}" width="30%">
								<figcaption class="media-body" style="margin-left:30px; margin-top:10px;">
									<h4 class="title text-truncate">${item.type}</h4>
									<dl class="dlist-inline">
									  <dt>Product Description: </dt>
									  <dd>${item.description}</dd>
									</dl>
									<dl class="dlist-inline">
									  <dt>Size:</dt>
									  <dd>${item.size}</dd>
									</dl>
									<dl class="dlist-inline">
									  <dt>Best to wear when you're feeling:</dt>
									  <dd>${item.mood}</dd>
									</dl>
								</figcaption>
							</figure>
						</td>

						<td>
							<dl class="dlist-inline text-grey" style="margin-top:10px;">
							  <dt>${item.function}</dt>
							</dl>
						</td>
						<td class="text-left">
							<a title="" href="" class="btn btn-outline-success" data-toggle="tooltip" data-original-title="Save to Wishlist"> <i class="fa fa-heart"></i></a>
							<a href="" class="btn btn-outline-danger remove_item" id="${item.clothesid}"> Ã— Remove</a>
						</td>
					</tr>`
			})

			// Get customer 
            var url = "https://liuzuolin1996-eval-test.apigee.net/customers/customers";
            

			$.getJSON(url, function (data) {
				console.log("getting latest customer");
				var customer = data["Customer"][data["Customer"].length - 1];
				console.log(typeof customer);
				console.log(customer);

                var cid = customer["customerid"]
				var firstname = customer["firstname"]
				var lastname = customer["lastname"]
				var phonenumber = customer["phonenumber"]
				var address = customer["address"]
				var postalcode = customer["postalcode"]

				// console.log("DEBUGGING: "+firstname+" "+lastname+" "+phonenumber+" "+address+" "+postalcode)

				document.getElementById("input-name").value = firstname + " " + lastname
				document.getElementById("phonenumber").value = phonenumber
				document.getElementById("address").value = address
				document.getElementById("postalcode").value = postalcode


				console.log("testetstetsetst")


				//add customer info into local storage
				var customerArray = localStorage.getItem('customer') ? JSON.parse(localStorage.getItem('customer')) : []
				localStorage.setItem('customer', JSON.stringify(customerArray))

				var name = firstname + " " + lastname

				customerArray = {
          "customerid":cid,
					"name": name,
					"phonenumber": phonenumber,
					"address": address,
					"postalcode": postalcode,
				}

				localStorage.setItem('customer', JSON.stringify(customerArray))
                console.log("local storage has been set:")
                console.log(customerArray)

			});

            console.log(localStorage)
            
 
			result += `</tbody>
				<tbody>
					<tr>
						<td>
							<figure class="media">
								<figcaption class="media-body" style="margin-left:30px; margin-top:10px;"><br/>
									<h4 class="title text-truncate">Kindly confirm your delivery details: </h4><br/>
									<dl class="dlist-inline">
									  <dd>
											<div class="form-row">
												<div class="col form-group">
													<label><strong>Name:</strong></label>
													<input class="form-control" type="text" name="name" value="" id="input-name">
												</div>
												<div class="col form-group">
													<label><strong>Phone Number:</strong></label>
													<input class="form-control" type="text" value="" name="phone" id="phonenumber">
												</div>
											</div>
											<div class="form-row">
												<div class="col form-group">
													<label><strong>Address:</strong></label>
													<input class="form-control" type="text" name="address" value="" id="address">
												</div>
												<div class="col form-group">
													<label><strong>Postal Code:</strong></label>
													<input class="form-control" type="text" name="postalcode" value="" id="postalcode">
												</div>
											</div>

											<dt>Delivery option:</dt>
									  		<dd>Standard delivery. Items will be delivered within 3-5 working days.</dd><br/>
											<button type="submit" class="btn btn-green" id="confirm">Confirm your order</button>
											<button type="submit" class="btn btn-blue" id="confirm-no-rabbit">AMQPReceive not running</button>
									  </dd>
									</dl>
								</figcaption>
							</figure>
						</td>
					</tr>
				</tbody>
			</table>`



			$(".cart").on('click', '.remove_item', function (event) {
				// $(".remove_item").click(function () {
				event.preventDefault();
				$(this).closest('tr').remove();
				var deleteId = $(this).attr('id')
				var newArray = []
				itemsArray.forEach(function (item) {
					if (item.clothesid != deleteId) {
						newArray.push(item)
					}
				})
				localStorage.removeItem('items')
				localStorage.setItem('items', JSON.stringify(newArray))
				location.reload()
			})
		}

		$(".cart").html(result);
		result = "";


		// PASS TEST CASE
		$("#confirm").click(function () {

            console.log("pass case")

            console.log("local storage")
            console.log(localStorage)

			// add clothes from localstorage into order info
			var itemsArray = localStorage.getItem('items') ? JSON.parse(localStorage.getItem('items')) : []
			var add_order_items = []

			console.log("itemsArray here:")
			console.log(itemsArray)

			itemsArray.forEach(function (item) {
				var item_string = item.clothesid + ''
				var orderID = { "clothesid": item_string }
				add_order_items.push(orderID)
			})

			console.log("add_order_items here:")
            console.log(add_order_items)
            
            var customer = JSON.parse(localStorage.getItem("customer"))
            var customerid = customer["customerid"]

            if (typeof customerid == "undefined" ) {
                customerid = 3
            }
        
			var orderInfo = {
        "customerid": customerid ,
				"add_order_items": add_order_items,
			}

			console.log("orderInfo here:")
            console.log(orderInfo)
        

			// THIS THING STOPS HERE FOR SOME REASON

			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
            // PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
            // PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS

									
			// var url = 'http://LAPTOP-M5IE8VM3:8080/order';
			// var url = "http://10.124.1.237:8080/order"
			var url ="https://liuzuolin1996-eval-test.apigee.net/orders/order"
			// var url = "http://a1c158e8.ngrok.io/order"

			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
			// PASSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
                    
            
            // alert("click to allow $.ajax")
            
            $.ajax({
				type: "POST",
				data: JSON.stringify(orderInfo),
				url: url,
				contentType: "application/json"
			});


            // alert("pass case pause: click to redirect")

		
			//##################################################################################################
			// UNCOMMENT THIS WHEN PRESENTING
			// localStorage.removeItem('items')



            console.log("redirecting now")
            try { 
                console.log("redirecting to orders-success")
                $(location).attr('href', '/orders-success')
                // window.location.replace("/orders-success")
                console.log("redirect line is over") 
			}
			catch (err) { 
                console.log("erorrrrrrrrr")
				console.log(err) 
			}

        });
        

        function sleep(miliseconds) {
            var currentTime = new Date().getTime();
        
            while (currentTime + miliseconds >= new Date().getTime()) {
            }
        }


        // FAIL TEST CASE
			$("#confirm-no-rabbit").click(function () {

            console.log("pass case")

            console.log("local storage")
            console.log(localStorage)

			// add clothes from localstorage into order info
			var itemsArray = localStorage.getItem('items') ? JSON.parse(localStorage.getItem('items')) : []
			var add_order_items = []

			console.log("itemsArray here:")
			console.log(itemsArray)

			itemsArray.forEach(function (item) {
				var item_string = item.clothesid + ''
				var orderID = { "clothesid": item_string }
				add_order_items.push(orderID)
			})

			console.log("add_order_items here:")
            console.log(add_order_items)
            
            var customer = JSON.parse(localStorage.getItem("customer"))
            var customerid = customer["customerid"]

            if (typeof customerid == "undefined" ) {
                customerid = 3
            }
        
			var orderInfo = {
        "customerid": customerid ,
				"add_order_items": add_order_items,
			}

			console.log("orderInfo here:")
            console.log(orderInfo)
        

			// THIS THING STOPS HERE FOR SOME REASON

	
			// var url = 'http://LAPTOP-M5IE8VM3:8080/order';
			// var url = "http://10.124.1.237:8080/order"
			var url ="https://liuzuolin1996-eval-test.apigee.net/orders/order"
			// var url = "http://a1c158e8.ngrok.io/order"

            
            // alert("click to allow $.ajax")
            
            $.ajax({
				type: "POST",
				data: JSON.stringify(orderInfo),
				url: url,
				contentType: "application/json"
			});


            
            alert("sending to rabbit mq (this takes some time)")
		
			//##################################################################################################
			// UNCOMMENT THIS WHEN PRESENTING
			// localStorage.removeItem('items')



            console.log("redirecting now")
            try { 
                console.log("redirecting to orders-success")
                $(location).attr('href', '/orders-success-no-rabbit')
                // window.location.replace("/orders-success")
                console.log("redirect line is over") 
			}
			catch (err) { 
                console.log("erorrrrrrrrr")
				console.log(err) 
			}

		});
	})
</script>

</html>